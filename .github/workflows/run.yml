name: Create mirror release

on:
  repository_dispatch:
  schedule:
    # Every 4 hours
    - cron:  "0 */4 * * *"

env:
  SPACEMACS_REPO: syl20bnr/spacemacs
  SPACEMACS_BRANCH: develop
  SPACEMACS_DIR: spacemacs
  MIRROR_SCRIPT: ./create_mirror
  EM_SCRIPT_PATH: $HOME/elpa-mirror.el
  MIRROR_DIR: /tmp/elpa 
  MIRROR_NAME: elpa.zip
  RELEASE_NAME: elpamirror
  EM_SCRIPT_URL: "https://raw.githubusercontent.com/\
  redguardtoo/\
  elpa-mirror/\
  master/\
  elpa-mirror.el"

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Install Emacs
      uses: purcell/setup-emacs@master
      with:
        version: 27.1

    - name: Download elpa-mirror.el
      run: curl -o ${{ env.EM_SCRIPT_PATH }} ${{ env.EM_SCRIPT_URL }}

    - uses: actions/checkout@v2

    - name: checkout Spacemacs repo
      uses: actions/checkout@v2
      with:
        repository: ${{ env.SPACEMACS_REPO }}
        ref: ${{ env.SPACEMACS_BRANCH }}
        path: ${{ env.SPACEMACS_DIR }}

    - name: Create local mirror
      run: ${{ env.MIRROR_SCRIPT }}

    - name: Archive mirror
      run: zip -r -j elpa.zip ${{ env.MIRROR_DIR }}

    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ hashFiles('elpa.zip') }}
        release_name: ${{ env.RELEASE_NAME }}
        body: Spacemacs elpa mirror for testing
        draft: false
        prerelease: false

    - name: Upload Release Asset
      id: upload-release-asset 
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: elpa.zip
        asset_name: ${{ env.MIRROR_NAME }}
        asset_content_type: application/zip
