name: Create mirror release

on:
  workflow_dispatch:
  schedule:
    # Every 4 hours
    - cron:  "0 */4 * * *"

env:
  SPACEMACS_REPO: syl20bnr/spacemacs
  SPACEMACS_BRANCH: develop
  EM_SCRIPT_URL: "https://raw.githubusercontent.com/\
  redguardtoo/\
  elpa-mirror/\
  master/\
  elpa-mirror.el"

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Install Emacs
      uses: purcell/setup-emacs@master
      with:
        version: 27.1

    - name: Download elpa-mirror.el
      run: curl -o "${HOME}/elpa-mirror.el" ${{ env.EM_SCRIPT_URL }}

    - uses: actions/checkout@v2

    - name: checkout Spacemacs repo
      uses: actions/checkout@v2
      with:
        repository: ${{ env.SPACEMACS_REPO }}
        ref: ${{ env.SPACEMACS_BRANCH }}
        path: spacemacs

    - name: Create local mirror
      run: ./create_mirror

    - name: Archive mirror
      run: zip -r -j elpa.zip testelpa

    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ hashFiles('testelpa/archive-contents') }}
        release_name: testelpa
        body: Spacemacs elpa mirror for testing
        draft: false
        prerelease: false

    - name: Upload Release Asset
      id: upload-release-asset 
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: elpa.zip
        asset_name: elpa.zip
        asset_content_type: application/zip
